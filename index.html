<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WizTrail</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
 integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
 integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- WizTrail CSS -->
<link rel="stylesheet" href="wiztrail.css">

</head>
<body data-theme="dark">
<header class="app-header">
  <div class="app-brand">
    <img src="img/logo.svg" alt="WizTrail" class="brand-img">
    <svg class="brand-mark" viewBox="0 0 24 24" aria-hidden="true">
      <defs>
        <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0" stop-color="#4fd1c5"/>
          <stop offset="1" stop-color="#0ea5e9"/>
        </linearGradient>
      </defs>
      <circle cx="12" cy="12" r="10" fill="url(#g)"/>
      <path d="M7 12l3 3 7-7" fill="none" stroke="#021" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <span class="brand-name">WizTrail</span>
  </div>
  <div class="app-header-actions">
    <!-- opzionale: spazio per bottoni/tema -->
  </div>
</header>
<div class="wrap">

<h1>
  <span>WizTrail</span>
  <span class="theme-ctrl">
    <label class="mini">Tema</label>
    <select id="themeSel">
      <option value="dark" selected>Scuro</option>
      <option value="light">Chiaro</option>
    </select>
  </span>
</h1>

<!-- NAV TABS -->
<div class="tabs">
  <button class="tab-btn active" data-tab="calc">Calcolatore</button>
  <button class="tab-btn" data-tab="map2d">Mappa 2D</button>
  <button class="tab-btn" data-tab="howto">How‑to</button>
  <button class="tab-btn" data-tab="fond">Fondamenti</button>
  <button class="tab-btn" data-tab="lic">Licenze & Policy</button>
</div>

<!-- PANEL: CALCOLATORE -->
<section id="calc" class="panel active">
  <div class="card grid grid-2">

    <!-- SINISTRA -->
    <div>
      <fieldset>
        <legend>Traccia GPS (opzionale)</legend>
        <label>Carica GPX/TCX</label>
        <input id="gpxfile" type="file" accept=".gpx,.tcx"/>
        <div id="gpxInfo" class="mini" style="margin-top:6px;"></div>
      </fieldset>

      <fieldset>
        <legend>Parametri atleta</legend>
        <label>Tempo 10 km (mm:ss)</label>
        <input id="t10k" type="text" value="50:00"/>
      </fieldset>

      <fieldset>
        <legend>Parametri gara</legend>
        <label>Distanza (km)</label>
        <input id="dist" type="number" step="0.001" value="21.097"/>
        <label>D+ (m)</label>
        <input id="dplus" type="number" step="1" value="0"/>
        <label>α (km ogni 100 m D+)</label>
        <input id="alpha" type="number" step="0.05" min="0.1" max="2" value="0.8"/>
      </fieldset>
    </div>

    <!-- DESTRA -->
    <div>
      <fieldset>
        <legend>Terreno</legend>
        <label>% Strada</label><input id="p_strada" type="number" value="0"/>
        <label>% E</label><input id="p_e" type="number" value="50"/>
        <label>% EE</label><input id="p_ee" type="number" value="50"/>
        <label>% EA</label><input id="p_ea" type="number" value="0"/>
        <label>Rall. E (%)</label><input id="c_e" type="number" value="3"/>
        <label>Rall. EE (%)</label><input id="c_ee" type="number" value="12"/>
        <label>Rall. EA (%)</label><input id="c_ea" type="number" value="25"/>
        <div id="terrainWarn" class="error"></div>
      </fieldset>

      <fieldset>
        <legend>Condizioni gara</legend>

        <label>Meteo</label>
        <select id="meteo">
          <option value="1.00">Fresco</option>
          <option value="1.02">Mite</option>
          <option value="1.04" selected>Caldo</option>
          <option value="1.07">Molto caldo</option>
        </select>

        <label>Altitudine</label>
        <select id="alt">
          <option value="1.00">≤500 m</option>
          <option value="1.01">500–1000 m</option>
          <option value="1.02" selected>1000–1500 m</option>
          <option value="1.03">1500–2000 m</option>
          <option value="1.04">>2000 m</option>
        </select>

        <label>Accumulo fatica</label>
        <select id="fatica">
          <option value="1.00">Basso</option>
          <option value="1.02">Medio</option>
          <option value="1.03" selected>Alto</option>
        </select>

        <label>Familiarità</label>
        <input id="spec" type="range" min="0" max="1" step="0.1" value="0.3"/>

        <label>Margine ±%</label>
        <input id="margin" type="number" value="3"/>
      </fieldset>

      <div class="toolbar">
        <button class="btn" id="calcBtn">Calcola</button>
        <button class="btn secondary" id="resetBtn">Reset</button>
      </div>
      <div id="msg" class="mini"></div>

      <div class="grid" style="margin-top:8px">
        <div class="kpi"><h3>Tempo finale</h3><div class="val" id="outFinal">—:—</div></div>
        <div class="kpi"><h3>Basso</h3><div class="val" id="outLow">—:—</div></div>
        <div class="kpi"><h3>Alto</h3><div class="val" id="outHigh">—:—</div></div>
      </div>
    </div>

  </div>
</section>

<!-- PANEL: MAPPA 2D -->
<section id="map2d" class="panel">
  <div class="card">
    <h2>Mappa 2D</h2>

    <div id="leafletMap"></div>

    <button class="btn" id="btnFit">Centra sulla traccia</button>
    <button class="btn secondary" id="btnKml">Scarica KML</button>

    <div class="profile-wrap">
  <canvas id="distCanvas"></canvas>
  <div id="distStats" class="mini">Carica una traccia per mostrare la progressione chilometrica.</div>
</div>

    <div class="banner-3d">
      Stampa la tua traccia in <b>3D!</b><br>
      Trasformala in un ricordo (medaglia, modellino, trofeo...)<br>
      <a>#Servizio in arrivo</a>
    </div>

  </div>
</section>

<!-- PANEL: HOWTO -->
<section id="howto" class="panel">
  <div class="card">
    <h2>How‑to</h2>

    <details open>
      <summary><b>1) Calcolatore — guida completa ai parametri</b></summary>
      <div style="margin-top:10px">

        <h3>Traccia GPS (opzionale)</h3>
        <ul>
          <li><b>Carica GPX/TCX</b>: se importi una traccia, il sistema legge automaticamente <i>Distanza</i> e <i>D+</i> (dislivello positivo). Puoi comunque modificarli a mano dopo l’import.</li>
        </ul>

        <h3>Parametri atleta</h3>
        <ul>
          <li><b>Tempo 10 km (mm:ss)</b> — È il tuo riferimento su strada e pianeggiante. Serve per “ancorare” la previsione: da questo valore il modello ricava il tuo passo/ritmo di base e lo adatta alla distanza reale di gara. 
            <div class="mini">Consiglio: usa il miglior tempo recente in condizioni buone. Se non hai un 10K, usa il ritmo medio su 5K/15K e converti a stima.</div>
          </li>
        </ul>

        <h3>Parametri gara</h3>
        <ul>
          <li><b>Distanza (km)</b> — i chilometri della gara/traccia che vuoi stimare. Se hai caricato una traccia, è già compilato.</li>
          <li><b>D+ (m)</b> — somma delle salite (metri) lungo il percorso. A parità di distanza, più D+ = più “fatica equivalente”.</li>
          <li><b>α (km ogni 100 m D+)</b> — “quanto pesano” le salite in <i>chilometri equivalenti</i>. 
            <div class="mini">Esempio: con α=0.8, ogni 100 m di D+ “valgono” 0.8 km in più: se hai 700 m D+, aggiungi 5.6 km equivalenti.</div>
            <div class="mini">Range tipico: 0.6–1.0 per trail corribili; 1.0–1.2 per percorsi lenti/pendenze cattive.</div>
          </li>
        </ul>

        <h3>Terreno</h3>
        <p>Indica <b>la percentuale</b> del tempo o della distanza stimata fatta su:</p>
        <ul>
          <li><b>% Strada</b> — asfalto o sterrato molto scorrevole</li>
          <li><b>% E</b> — sentiero escursionistico facile</li>
          <li><b>% EE</b> — tecnico (pietre, radici, passaggi stretti)</li>
          <li><b>% EA</b> — attrezzato/esposto (lento, molto tecnico)</li>
        </ul>
        <p>Somma <b>deve arrivare al 100%</b>. In base alla tecnicità, si applicano <b>rallentamenti</b> dedicati:</p>
        <ul>
          <li><b>Rall. E (%)</b> — penalità extra su E (es. +3%)</li>
          <li><b>Rall. EE (%)</b> — penalità su EE (es. +12%)</li>
          <li><b>Rall. EA (%)</b> — penalità su EA (es. +25%)</li>
        </ul>
        <div class="mini">Suggerimento rapido: se non conosci bene il percorso, inizia con Strada/E/EE/EA ≈ 10/50/25/15 e rallentamenti default; poi affina dopo un’uscita ricognitiva.</div>

        <h3>Condizioni gara</h3>
        <ul>
          <li><b>Meteo</b> — seleziona la fascia: “Fresco” (quasi neutro), “Mite”, “Caldo”, “Molto caldo”. Crescendo la temperatura, cresce la penalità.</li>
          <li><b>Altitudine</b> — quota media stimata del percorso (o quota della gara). Più sali oltre i 1000–1500 m, maggiore l’impatto fisiologico sulla prestazione.</li>
          <li><b>Fatica</b> — quanto incide per te l'accumulo di fatica nel corso della gara (Bassa/Media/Alta). Il modello la “pesa” di più se la distanza è lunga.</li>
          <li><b>Specificità (S 0–1)</b> — quanto sei abituato proprio a <i>quel tipo</i> di gara (trail tecnico, salite/discese, quota, caldo). 
            <div class="mini">0 = atleta “stradalista” non abituato; 1 = atleta molto abituato (penalità ridotte).</div>
          </li>
          <li><b>Margine ±%</b> — intervallo di confidenza che vuoi visualizzare attorno alla stima centrale (es. ±3%). Rende chiaro il range “Basso/Alto”.</li>
        </ul>

        <h3>Come nasce la stima (in parole semplici)</h3>
        <ol>
          <li>Partiamo dal tuo <b>ritmo sui 10K</b> (strada, pianura) per ricavare una base.</li>
          <li>Adattiamo quel ritmo alla <b>distanza</b> della gara (il decadimento non è lineare).</li>
          <li>Convertiamo il <b>dislivello (D+)</b> in “km equivalenti” tramite <b>α</b> (più salita ⇒ più km equivalenti).</li>
          <li>Applichiamo l’effetto <b>terreno/tecnicità</b> con le percentuali e i relativi rallentamenti.</li>
          <li>Aggiungiamo l’impatto di <b>meteo</b> e <b>altitudine</b>.</li>
          <li>Moduliamo la <b>fatica</b> in funzione della distanza (pesa davvero sui lunghi).</li>
          <li>Applichiamo la <b>specificità (S)</b>: se sei abituato a quel contesto, le penalità calano.</li>
          <li>Mostriamo la stima centrale e il <b>range</b> in base al tuo <b>margine</b> ±%.</li>
        </ol>

        <h3>Impostazioni rapide consigliate</h3>
        <ul>
          <li><b>Gara trail “corribile” (colline)</b>: α=0.7–0.9; Strada/E/EE/EA ≈ 15/55/25/5; Meteo “Mite”; Alt “≤500 m”; S=0.4–0.7; Margine ±3–5%.</li>
          <li><b>Trail tecnico (montagna)</b>: α=0.9–1.1; Strada/E/EE/EA ≈ 5/40/40/15; Meteo “Fresco/Mite”; Alt “1000–1500 m” o più; S=0.2–0.6; Margine ±5–8%.</li>
          <li><b>Gara calda</b>: mantieni α come sopra, ma Meteo “Caldo/Molto caldo”; aumenta Margine (±5–8%) se non sei acclimatato.</li>
        </ul>

      </div>
    </details>

    <details>
      <summary><b>2) Mappa 2D (uso sintetico)</b></summary>
      <ul>
        <li><b>Carica una traccia</b> per vedere il percorso su mappa.</li>
        <li>Usa <b>“Centra sulla traccia”</b> per inquadrare il percorso intero.</li>
        <li>La <b>linea distanza</b> (sezione Mappa) mostra i marcatori chilometrici; passando il mouse, puoi sincronizzare punti.</li>
        <li><b>Scarica KML</b> per usare il percorso in strumenti esterni (es. stampa 3D del tracciato).</li>
      </ul>
    </details>

    <details>
      <summary><b>3) Fondamenti (brevi note)</b></summary>
      <ul>
        <li>La stima si basa su un modello <b>Riegel adattivo</b> + <b>chilometri equivalenti</b> da D+ (coeff. α) + <b>fattori reali</b> (terreno, meteo, quota, fatica) e la tua <b>specificità</b>.</li>
        <li>Non è una “verità assoluta”, ma una <b>previsione realistica</b> che si affina con dati migliori (ricognizioni, split reali, acclimatazione).</li>
      </ul>
    </details>

    <details>
      <summary><b>4) Licenze & Policy (sintesi)</b></summary>
      <ul>
        <li>Usiamo librerie e tile map secondo le rispettive policy. Consulta la sezione dedicata per i crediti completi.</li>
      </ul>
    </details>

  </div>
</section>
<!-- PANEL: FONDAMENTI -->
<section id="fond" class="panel">
  <div class="card">
    <h2>Fondamenti scientifici e criteri di calcolo</h2>

    <p>
      Questa sezione spiega in modo trasparente tutti gli elementi scientifici,
      fisiologici ed empirici utilizzati nel modello di previsione di WizTrail,
      includendo fonti e riferimenti esterni.
    </p>

    <h3>1. Formula di Riegel (modello potenza, versione dinamica)</h3>
    <p>
      La formula originale di Riegel descrive il decadimento della velocità
      al crescere della distanza attraverso un'esponente <b>R</b>:
    </p>

    <pre style="white-space:pre-wrap;">
T₂ = T₁ × (D₂ / D₁) ^ R
    </pre>

    <p>
      La documentazione moderna riconosce che l’esponente R non può essere considerato
      costante per tutte le distanze, come spiegato in analisi avanzate dei modelli 
      predittivi (es. tabelle predittive modernizzate e chiarimenti forniti da provider 
      come TrainAsOne) [1](https://geographyfieldwork.com/Naismith.htm).  
      Le performance reali mostrano infatti che:
    </p>

    <ul>
      <li>su distanze brevi (5–15 km), R tende verso 1.03–1.055; [1](https://geographyfieldwork.com/Naismith.htm)</li>
      <li>su mezza maratona converge verso ~1.06; [1](https://geographyfieldwork.com/Naismith.htm)</li>
      <li>su maratona tende a 1.07–1.08; [1](https://geographyfieldwork.com/Naismith.htm)</li>
    </ul>

    <p>
      WizTrail implementa quindi un <b>Riegel dinamico</b>, con R che varia dolcemente
      in funzione della distanza per evitare sovrastime sulle distanze brevi e fornire 
      proiezioni più realistiche sulle lunghe.
    </p>

    <h3>2. Conversione salita → “chilometri equivalenti” (Naismith & fisiologia moderna)</h3>
    <p>
      La prima formulazione storica per stimare l’impatto della salita sul tempo è
      la regola di <b>Naismith (1902)</b>, che identifica l’ascesa come contributore 
      lineare all’incremento del tempo stimato, ed è tutt’oggi riportata nella 
      letteratura tecnica [2](https://geospatialcatalog.com/touchterrain).
    </p>

    <p>
      WizTrail usa quindi la conversione della salita in
      <b>chilometri equivalenti</b> tramite un coefficiente α:
    </p>

    <pre style="white-space:pre-wrap;">
D_equiv = D + α × (D⁺ / 100)
    </pre>

    <p>
      Il valore α (0.6–1.2) è coerente con evidenze moderne sul costo energetico 
      della corsa in salita (lineare fino a pendenze del 20%).
    </p>

    <h3>3. Costo metabolico di salita/discesa — Minetti et al.</h3>
    <p>
      Il riferimento fisiologico più rilevante è il lavoro di Minetti, che mostra 
      come il costo energetico vari con la pendenza: lineare in salita, minimo 
      intorno a –10% in discesa, e crescente su discese molto ripide 
      (Journal of Applied Physiology, 2002) [3](https://runbundle.com/tools/grade-adjusted-pace-calculator).
    </p>

    <p>
      WizTrail non replica l'intera curva di Minetti per semplicità computazionale, 
      ma recepisce i principi chiave nella costruzione dei km equivalenti.
    </p>

    <h3>4. Terreno e tecnicità: perché il GAP non basta</h3>
    <p>
      Il <b>Grade Adjusted Pace (GAP)</b> non considera la tecnicità del fondo:
      radici, pietre, sentiero stretto, superficie scivolosa ecc.  
      La documentazione ufficiale Strava conferma che il GAP corregge solo la
      pendenza, non difficoltà tecniche o instabilità del terreno 
      [4](https://storymaps.arcgis.com/stories/14a4b644bade481a83b10467126fc921).
    </p>

    <p>
      Per questo WizTrail utilizza coefficienti dedicati per:
    </p>

    <ul>
      <li>Strada → coefficiente 1.00</li>
      <li>E (escursionistico) → +3%</li>
      <li>EE (tecnico) → +12%</li>
      <li>EA (attrezzato/esposto) → +25%</li>
    </ul>

    <h3>5. Fatica progressiva (modello adattivo distanza-dipendente)</h3>
    <p>
      La fatica cresce <b>non linearmente</b> con la distanza, a causa di:
    </p>

    <ul>
      <li>deplezione del glicogeno</li>
      <li>accumulo di danno muscolare eccentrico (soprattutto in discesa)</li>
      <li>diminuzione della potenza erogabile sostenibile sul lungo</li>
      <li>aumento della temperatura interna</li>
    </ul>

    <p>
      Evidenze fisiologiche mostrano cambi di regime intorno ai 20–30 km, con 
      crescita più rapida della fatica oltre i 40 km.  
      Il modello WizTrail implementa quindi una <b>fatica pesata</b>:
    </p>

    <ul>
      <li><b>&lt;20 km</b>: impatto ridotto (~25%)</li>
      <li><b>20–40 km</b>: transizione</li>
      <li><b>&gt;40 km</b>: impatto completo</li>
    </ul>

    <h3>6. Meteo (temperatura) e Altitudine</h3>

    <p>
      Studi pubblicati su *Runner’s World* e *Running Writings* mostrano che
      le prestazioni ottimali avvengono tra 2–13 °C, con penalità significative
      sopra i 18–20 °C, e degradazioni stimate di +3–5% in area 23–26°C 
      [5](https://racethere.com/guides/altitude-running-acclimation-guide)[6](https://journals.physiology.org/doi/full/10.1152/japplphysiol.01177.2001).
    </p>

    <p>
      L’altitudine influisce sulla pressione parziale dell’ossigeno; già a 
      1000–1500 m si osserva un decremento misurabile delle prestazioni, come
      indicato in ricerche fisiologiche accademiche (J Appl Physiol, 2015)
      [7](https://iris.unibs.it/handle/11379/540545).
    </p>

    <h3>7. Specificità dell’allenamento (S)</h3>
    <p>
      La variabile <b>S</b> modula quanto le penalità legate a tecnicità, meteo e
      altitudine si applicano realmente all’atleta.  
      Un atleta abituato al trail vede penalità più basse; un atleta da strada
      è molto più penalizzato dagli stessi fattori.
    </p>

    <h3>8. Struttura finale del modello WizTrail</h3>

    <pre style="white-space:pre-wrap;">
Tempo finale =
  (Stima Riegel dinamica su base 10 km)
× (Conversione distanza equivalente)
× (Coefficiente tecnicità terreno)
× (Fattori meteo e altitudine)
× (Fatica adattiva in funzione della distanza)
× (Correzione specificità)
    </pre>

    <p>
      Questo approccio ibrido combina una base empirica (Riegel), principi 
      fisiologici moderni (fatica adattiva, metabolismo e temperatura),
      e componenti tecniche reali del trail running (terreno, D+, instabilità).
    </p>

  </div>
</section>

<!-- PANEL: LIC -->
<section id="lic" class="panel">
  <div class="card">
    <h2>Licenze & Policy</h2>
    <ul>
      <li>Leaflet utilizzato secondo il Quick Start ufficiale.</li>
      <li>Tile OSM via URL ufficiale (© OpenStreetMap contributors) secondo Tile Usage Policy.</li>
    </ul>
  </div>
</section>

<div class="footer">WizTrail © 2026</div>

<script>
/* ===========================
   THEME
=========================== */
document.getElementById("themeSel").addEventListener("change", e => {
  document.body.setAttribute("data-theme", e.target.value);
});

/* ===========================
   TABS
=========================== */
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
    if (btn.dataset.tab === "map2d") {
      initLeaflet();
      setTimeout(() => {
        drawProfile();
        fitTrack();
      }, 120);
    }
  });
});

/* ===========================
   HAVERSINE
=========================== */
function hav(a,b,c,d){
  const R = 6371000;
  const t = Math.PI/180;
  const dLat = (c-a)*t;
  const dLon = (d-b)*t;
  const k = Math.sin(dLat/2)**2 +
            Math.cos(a*t)*Math.cos(c*t)*Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(k));
}

/* ===========================
   PARSE GPX / TCX
=========================== */
function parseTrack(xml){
  const pts=[];
  const g=xml.getElementsByTagName("trkpt");

  if(g.length){
    [...g].forEach(n=>{
      const la=parseFloat(n.getAttribute("lat"));
      const lo=parseFloat(n.getAttribute("lon"));
      const e=n.getElementsByTagName("ele")[0];
      pts.push([la,lo,e ? parseFloat(e.textContent) : 0]);
    });
    return pts;
  }

  const t=xml.getElementsByTagName("Trackpoint");
  [...t].forEach(n=>{
    const p=n.getElementsByTagName("Position")[0];
    if(!p)return;

    const la=p.getElementsByTagName("LatitudeDegrees")[0];
    const lo=p.getElementsByTagName("LongitudeDegrees")[0];
    const el=n.getElementsByTagName("AltitudeMeters")[0];

    pts.push([
      la ? parseFloat(la.textContent) : 0,
      lo ? parseFloat(lo.textContent) : 0,
      el ? parseFloat(el.textContent) : 0
    ]);
  });

  return pts;
}

/* ===========================
   COMPUTE METRICS
=========================== */
function compute(pts){
  if(pts.length<2) return {km:0,gain:0,e:[],d:[]};

  const elev = pts.map(p => p[2]);
  const d = [0];
  let dist=0, gain=0;

  for(let i=1; i<pts.length; i++){
    const dd = hav(pts[i-1][0], pts[i-1][1], pts[i][0], pts[i][1]);
    if(dd < 300) dist += dd;
    d[i] = dist;
    const de = elev[i] - elev[i-1];
    if(de > 1) gain += de;
  }

  return { km: dist/1000, gain, e: elev, d };
}

/* ===========================
   GLOBAL STATE
=========================== */
let gpxPts = [];
let metrics = {e:[], d:[]};

/* ===========================
   LOAD GPX
=========================== */
document.getElementById("gpxfile").addEventListener("change", async e => {
  const f = e.target.files[0];
  if(!f) return;
  
  const txt = await f.text();
  const xml = new DOMParser().parseFromString(txt,"application/xml");

  gpxPts = parseTrack(xml);
  metrics = compute(gpxPts);

  document.getElementById("dist").value = metrics.km.toFixed(3);
  document.getElementById("dplus").value = metrics.gain;
  document.getElementById("gpxInfo").textContent =
    `Punti: ${gpxPts.length}, ${metrics.km.toFixed(2)} km, D+: ${metrics.gain} m`;

  drawTrack();
  drawProfile();
});

/* ===========================
   LEAFLET
=========================== */
let map=null, poly=null, hoverMarker=null;

function initLeaflet(){
  if(map) return;

  map = L.map("leafletMap");
  L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom:19,
    attribution:"© OpenStreetMap contributors"
  }).addTo(map);

  hoverMarker = L.circleMarker([0,0],{
    radius:6,
    color:"#ff0",
    fillColor:"#ff0"
  });

  map.setView([46.5,8.3],5);
}

function drawTrack(){
  if(!map || !gpxPts.length) return;
  if(poly) map.removeLayer(poly);

  poly = L.polyline(gpxPts.map(p => [p[0], p[1]]),{
    color:"#4fd1c5",
    weight:4
  }).addTo(map);

  fitTrack();
}

function fitTrack(){
  if(poly) map.fitBounds(poly.getBounds(), {padding:[20,20]});
}

document.getElementById("btnFit").onclick = fitTrack;

/* ===========================
   KML
=========================== */
document.getElementById("btnKml").onclick = () => {
  if(!gpxPts.length){
    alert("Carica prima un GPX");
    return;
  }

  const coords = gpxPts.map(p => `${p[1]},${p[0]},${p[2]}`).join(" ");

  const kml = `<?xml version="1.0"?>
<kml xmlns="http://www.opengis.net/kml/2.2"><Document>
<Placemark><name>Percorso</name>
<LineString><coordinates>${coords}</coordinates></LineString>
</Placemark></Document></kml>`;

  const blob = new Blob([kml], {type:"application/vnd.google-earth.kml+xml"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "wiztrail.kml";
  a.click();
};

/* ===========================
   CALCOLO TEMPO – COMPLETAMENTE CORRETTO
=========================== */
const readNum = id => parseFloat(
  document.getElementById(id).value.replace(",",".")
) || 0;

document.getElementById("calcBtn").onclick = () => {

  const msg = document.getElementById("msg");
  msg.textContent = "";

  const t10 = document.getElementById("t10k").value;
  if(!/^[0-9]+:[0-5][0-9]$/.test(t10)){
    msg.textContent = "Formato 10K non valido";
    return;
  }

  const m10 = parseInt(t10.split(":")[0]) + parseInt(t10.split(":")[1]) / 60;

  const D  = readNum("dist");
  const Dp = readNum("dplus");
  const a  = readNum("alpha");

  /* ===== RIEGEL DINAMICO PATCHATO ===== */
  let expo;
  if (D <= 20) expo = Math.max(1.03, 1.03 + 0.002*(D - 10));
  else if (D <= 42) expo = 1.05 + 0.0007*(D - 20);
  else expo = 1.075;

  const base = m10 * Math.pow(D / 10, expo);
  const D_eq = D + (Dp/100) * a;
  const T_elev = base * (D_eq / D);

  /* ===== TERRENO PATCHATO ===== */
  const pS  = readNum("p_strada")/100;
  const pE  = readNum("p_e")/100;
  const pEE = readNum("p_ee")/100;
  const pEA = readNum("p_ea")/100;

  if(Math.abs(pS + pE + pEE + pEA - 1) > 0.01){
    msg.textContent = "Somma % ≠100";
    return;
  }

  const cE  = readNum("c_e")/100;
  const cEE = readNum("c_ee")/100;
  const cEA = readNum("c_ea")/100;

  const terr =
      pS  * 1
    + pE  * (1 + cE)
    + pEE * (1 + cEE)
    + pEA * (1 + cEA);

  const bm = readNum("meteo");
  const ba = readNum("alt");

  /* ===== FATICA ===== */
  let fw;
  if (D <= 20) fw = 0.25;
  else if (D <= 40) fw = 0.25 + 0.03*(D-20);
  else fw = 1.0;

  const bf_raw = readNum("fatica");
  const bf = 1 + (bf_raw - 1) * fw;

  /* ===== SPECIFICITÀ ===== */
  const S   = readNum("spec");
  const mrg = readNum("margin")/100;

  const raw = terr * bm * ba * bf;

const gamma = 0.75;
const adj = Math.max(1, 1 + (raw - 1) * Math.pow(1 - S, gamma));

const T = T_elev * adj;

  const fmt = t => {
    const s = Math.round(t*60);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const se= s%60;
    return h ?
      `${h}:${String(m).padStart(2,"0")}:${String(se).padStart(2,"0")}` :
      `${m}:${String(se).padStart(2,"0")}`;
  };

  document.getElementById("outFinal").textContent = fmt(T);
  document.getElementById("outLow").textContent   = fmt(T*(1-mrg));
  document.getElementById("outHigh").textContent  = fmt(T*(1+mrg));
  msg.textContent = "OK";
};

/* ===========================
   RESET
=========================== */
document.getElementById("resetBtn").onclick = () => location.reload();

</script>
</body>
</html>