<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WizTrail</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
 integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
 integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- WizTrail CSS -->
<link rel="stylesheet" href="wiztrail.css">

</head>
<body data-theme="dark">
<div class="wrap">

<h1>
  <span>WizTrail</span>
  <span class="theme-ctrl">
    <label class="mini">Tema</label>
    <select id="themeSel">
      <option value="dark" selected>Scuro</option>
      <option value="light">Chiaro</option>
    </select>
  </span>
</h1>

<!-- NAV TABS -->
<div class="tabs">
  <button class="tab-btn active" data-tab="calc">Calcolatore</button>
  <button class="tab-btn" data-tab="map2d">Mappa 2D</button>
  <button class="tab-btn" data-tab="howto">How‑to</button>
  <button class="tab-btn" data-tab="fond">Fondamenti</button>
  <button class="tab-btn" data-tab="lic">Licenze & Policy</button>
</div>

<!-- PANEL: CALCOLATORE -->
<section id="calc" class="panel active">
  <div class="card grid grid-2">

    <!-- SINISTRA -->
    <div>
      <fieldset>
        <legend>Traccia GPS (opzionale)</legend>
        <label>Carica GPX/TCX</label>
        <input id="gpxfile" type="file" accept=".gpx,.tcx"/>
        <div id="gpxInfo" class="mini" style="margin-top:6px;"></div>
      </fieldset>

      <fieldset>
        <legend>Parametri atleta</legend>
        <label>Tempo 10 km (mm:ss)</label>
        <input id="t10k" type="text" value="50:00"/>
      </fieldset>

      <fieldset>
        <legend>Parametri gara</legend>
        <label>Distanza (km)</label>
        <input id="dist" type="number" step="0.001" value="21.097"/>
        <label>D+ (m)</label>
        <input id="dplus" type="number" step="1" value="700"/>
        <label>α (km ogni 100 m D+)</label>
        <input id="alpha" type="number" step="0.05" min="0.1" max="2" value="0.8"/>
      </fieldset>
    </div>

    <!-- DESTRA -->
    <div>
      <fieldset>
        <legend>Terreno</legend>
        <label>% Strada</label><input id="p_strada" type="number" value="10"/>
        <label>% E</label><input id="p_e" type="number" value="50"/>
        <label>% EE</label><input id="p_ee" type="number" value="25"/>
        <label>% EA</label><input id="p_ea" type="number" value="15"/>
        <label>Rall. E (%)</label><input id="c_e" type="number" value="3"/>
        <label>Rall. EE (%)</label><input id="c_ee" type="number" value="12"/>
        <label>Rall. EA (%)</label><input id="c_ea" type="number" value="25"/>
        <div id="terrainWarn" class="error"></div>
      </fieldset>

      <fieldset>
        <legend>Condizioni gara</legend>

        <label>Meteo</label>
        <select id="meteo">
          <option value="1.00">Fresco</option>
          <option value="1.02">Mite</option>
          <option value="1.04" selected>Caldo</option>
          <option value="1.07">Molto caldo</option>
        </select>

        <label>Altitudine</label>
        <select id="alt">
          <option value="1.00">≤500 m</option>
          <option value="1.01">500–1000 m</option>
          <option value="1.02" selected>1000–1500 m</option>
          <option value="1.03">1500–2000 m</option>
          <option value="1.04">>2000 m</option>
        </select>

        <label>Fatica</label>
        <select id="fatica">
          <option value="1.00">Bassa</option>
          <option value="1.02">Media</option>
          <option value="1.03" selected>Alta</option>
        </select>

        <label>Specificità (S 0–1)</label>
        <input id="spec" type="range" min="0" max="1" step="0.1" value="0.3"/>

        <label>Margine ±%</label>
        <input id="margin" type="number" value="3"/>
      </fieldset>

      <div class="toolbar">
        <button class="btn" id="calcBtn">Calcola</button>
        <button class="btn secondary" id="resetBtn">Reset</button>
      </div>
      <div id="msg" class="mini"></div>

      <div class="grid" style="margin-top:8px">
        <div class="kpi"><h3>Tempo finale</h3><div class="val" id="outFinal">—:—</div></div>
        <div class="kpi"><h3>Basso</h3><div class="val" id="outLow">—:—</div></div>
        <div class="kpi"><h3>Alto</h3><div class="val" id="outHigh">—:—</div></div>
      </div>
    </div>

  </div>
</section>

<!-- PANEL: MAPPA 2D -->
<section id="map2d" class="panel">
  <div class="card">
    <h2>Mappa 2D</h2>

    <div id="leafletMap"></div>

    <button class="btn" id="btnFit">Centra sulla traccia</button>
    <button class="btn secondary" id="btnKml">Scarica KML</button>

    <div class="profile-wrap">
  <canvas id="distCanvas"></canvas>
  <div id="distStats" class="mini">Carica una traccia per mostrare la progressione chilometrica.</div>
</div>

    <div class="banner-3d">
      Stampa la tua traccia in <b>3D!</b><br>
      Trasformala in un ricordo (medaglia, modellino, trofeo...)<br>
      <a>#Servizio in arrivo</a>
    </div>

  </div>
</section>

<!-- PANEL: HOWTO -->
<section id="howto" class="panel">
  <div class="card">
    <h2>How‑to</h2>
    <ul>
      <li><b>Carica GPX/TCX</b>: WizTrail analizza distanza, D+ e genera profilo + mappa.</li>
      <li><b>Mappa</b>: muovi il puntatore sul profilo per vedere il punto corrispondente sulla mappa.</li>
      <li><b>KML</b>: puoi esportare il percorso in formato KML dalla sezione mappa.</li>
      <li><b>Previsione tempo gara</b>: inserisci 10K, terreno, α, meteo, altitudine, specificità.</li>
      <li><b>Tema</b>: seleziona “Chiaro/Scuro” dal menù in alto.</li>
    </ul>
  </div>
</section>

<!-- PANEL: FONDAMENTI -->
<section id="fond" class="panel">
  <div class="card">
    <h2>Fondamenti scientifici e criteri di calcolo</h2>

    <p>
      Questa sezione spiega in modo trasparente tutti gli elementi scientifici,
      fisiologici ed empirici utilizzati nel modello di previsione di WizTrail,
      includendo fonti e riferimenti esterni.
    </p>

    <h3>1. Formula di Riegel (modello potenza, versione dinamica)</h3>
    <p>
      La formula originale di Riegel descrive il decadimento della velocità
      al crescere della distanza attraverso un'esponente <b>R</b>:
    </p>

    <pre style="white-space:pre-wrap;">
T₂ = T₁ × (D₂ / D₁) ^ R
    </pre>

    <p>
      La documentazione moderna riconosce che l’esponente R non può essere considerato
      costante per tutte le distanze, come spiegato in analisi avanzate dei modelli 
      predittivi (es. tabelle predittive modernizzate e chiarimenti forniti da provider 
      come TrainAsOne) [1](https://geographyfieldwork.com/Naismith.htm).  
      Le performance reali mostrano infatti che:
    </p>

    <ul>
      <li>su distanze brevi (5–15 km), R tende verso 1.03–1.055; [1](https://geographyfieldwork.com/Naismith.htm)</li>
      <li>su mezza maratona converge verso ~1.06; [1](https://geographyfieldwork.com/Naismith.htm)</li>
      <li>su maratona tende a 1.07–1.08; [1](https://geographyfieldwork.com/Naismith.htm)</li>
    </ul>

    <p>
      WizTrail implementa quindi un <b>Riegel dinamico</b>, con R che varia dolcemente
      in funzione della distanza per evitare sovrastime sulle distanze brevi e fornire 
      proiezioni più realistiche sulle lunghe.
    </p>

    <h3>2. Conversione salita → “chilometri equivalenti” (Naismith & fisiologia moderna)</h3>
    <p>
      La prima formulazione storica per stimare l’impatto della salita sul tempo è
      la regola di <b>Naismith (1902)</b>, che identifica l’ascesa come contributore 
      lineare all’incremento del tempo stimato, ed è tutt’oggi riportata nella 
      letteratura tecnica [2](https://geospatialcatalog.com/touchterrain).
    </p>

    <p>
      WizTrail usa quindi la conversione della salita in
      <b>chilometri equivalenti</b> tramite un coefficiente α:
    </p>

    <pre style="white-space:pre-wrap;">
D_equiv = D + α × (D⁺ / 100)
    </pre>

    <p>
      Il valore α (0.6–1.2) è coerente con evidenze moderne sul costo energetico 
      della corsa in salita (lineare fino a pendenze del 20%).
    </p>

    <h3>3. Costo metabolico di salita/discesa — Minetti et al.</h3>
    <p>
      Il riferimento fisiologico più rilevante è il lavoro di Minetti, che mostra 
      come il costo energetico vari con la pendenza: lineare in salita, minimo 
      intorno a –10% in discesa, e crescente su discese molto ripide 
      (Journal of Applied Physiology, 2002) [3](https://runbundle.com/tools/grade-adjusted-pace-calculator).
    </p>

    <p>
      WizTrail non replica l'intera curva di Minetti per semplicità computazionale, 
      ma recepisce i principi chiave nella costruzione dei km equivalenti.
    </p>

    <h3>4. Terreno e tecnicità: perché il GAP non basta</h3>
    <p>
      Il <b>Grade Adjusted Pace (GAP)</b> non considera la tecnicità del fondo:
      radici, pietre, sentiero stretto, superficie scivolosa ecc.  
      La documentazione ufficiale Strava conferma che il GAP corregge solo la
      pendenza, non difficoltà tecniche o instabilità del terreno 
      [4](https://storymaps.arcgis.com/stories/14a4b644bade481a83b10467126fc921).
    </p>

    <p>
      Per questo WizTrail utilizza coefficienti dedicati per:
    </p>

    <ul>
      <li>Strada → coefficiente 1.00</li>
      <li>E (escursionistico) → +3%</li>
      <li>EE (tecnico) → +12%</li>
      <li>EA (attrezzato/esposto) → +25%</li>
    </ul>

    <h3>5. Fatica progressiva (modello adattivo distanza-dipendente)</h3>
    <p>
      La fatica cresce <b>non linearmente</b> con la distanza, a causa di:
    </p>

    <ul>
      <li>deplezione del glicogeno</li>
      <li>accumulo di danno muscolare eccentrico (soprattutto in discesa)</li>
      <li>diminuzione della potenza erogabile sostenibile sul lungo</li>
      <li>aumento della temperatura interna</li>
    </ul>

    <p>
      Evidenze fisiologiche mostrano cambi di regime intorno ai 20–30 km, con 
      crescita più rapida della fatica oltre i 40 km.  
      Il modello WizTrail implementa quindi una <b>fatica pesata</b>:
    </p>

    <ul>
      <li><b>&lt;20 km</b>: impatto ridotto (~25%)</li>
      <li><b>20–40 km</b>: transizione</li>
      <li><b>&gt;40 km</b>: impatto completo</li>
    </ul>

    <h3>6. Meteo (temperatura) e Altitudine</h3>

    <p>
      Studi pubblicati su *Runner’s World* e *Running Writings* mostrano che
      le prestazioni ottimali avvengono tra 2–13 °C, con penalità significative
      sopra i 18–20 °C, e degradazioni stimate di +3–5% in area 23–26°C 
      [5](https://racethere.com/guides/altitude-running-acclimation-guide)[6](https://journals.physiology.org/doi/full/10.1152/japplphysiol.01177.2001).
    </p>

    <p>
      L’altitudine influisce sulla pressione parziale dell’ossigeno; già a 
      1000–1500 m si osserva un decremento misurabile delle prestazioni, come
      indicato in ricerche fisiologiche accademiche (J Appl Physiol, 2015)
      [7](https://iris.unibs.it/handle/11379/540545).
    </p>

    <h3>7. Specificità dell’allenamento (S)</h3>
    <p>
      La variabile <b>S</b> modula quanto le penalità legate a tecnicità, meteo e
      altitudine si applicano realmente all’atleta.  
      Un atleta abituato al trail vede penalità più basse; un atleta da strada
      è molto più penalizzato dagli stessi fattori.
    </p>

    <h3>8. Struttura finale del modello WizTrail</h3>

    <pre style="white-space:pre-wrap;">
Tempo finale =
  (Stima Riegel dinamica su base 10 km)
× (Conversione distanza equivalente)
× (Coefficiente tecnicità terreno)
× (Fattori meteo e altitudine)
× (Fatica adattiva in funzione della distanza)
× (Correzione specificità)
    </pre>

    <p>
      Questo approccio ibrido combina una base empirica (Riegel), principi 
      fisiologici moderni (fatica adattiva, metabolismo e temperatura),
      e componenti tecniche reali del trail running (terreno, D+, instabilità).
    </p>

  </div>
</section>

<!-- PANEL: LIC -->
<section id="lic" class="panel">
  <div class="card">
    <h2>Licenze & Policy</h2>
    <ul>
      <li>Leaflet utilizzato secondo il Quick Start ufficiale.</li>
      <li>Tile OSM via URL ufficiale (© OpenStreetMap contributors) secondo Tile Usage Policy.</li>
    </ul>
  </div>
</section>

<div class="footer">WizTrail © 2026</div>

<script>
/* ====== THEME ====== */
document.getElementById("themeSel").addEventListener("change",e=>{
  document.body.setAttribute("data-theme",e.target.value);
});

/* ====== TABS ====== */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
    if(btn.dataset.tab==="map2d"){ initLeaflet(); setTimeout(()=>{drawProfile(); fitTrack();},120);}
  });
});

/* ====== HAVERSINE ====== */
function hav(a,b,c,d){
  const R=6371000,t=Math.PI/180;
  const dLat=(c-a)*t,dLon=(d-b)*t;
  const k=Math.sin(dLat/2)**2 + Math.cos(a*t)*Math.cos(c*t)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(k));
}

/* ====== PARSE GPX / TCX ====== */
function parseTrack(xml){
  const pts=[];
  const g=xml.getElementsByTagName("trkpt");
  if(g.length){
    [...g].forEach(n=>{
      const la=parseFloat(n.getAttribute("lat"));
      const lo=parseFloat(n.getAttribute("lon"));
      const el=n.getElementsByTagName("ele")[0];
      const e=el?parseFloat(el.textContent):0;
      pts.push([la,lo,e]);
    });
    return pts;
  }
  const t=xml.getElementsByTagName("Trackpoint");
  [...t].forEach(n=>{
    const p=n.getElementsByTagName("Position")[0];
    if(!p)return;
    const la=p.getElementsByTagName("LatitudeDegrees")[0];
    const lo=p.getElementsByTagName("LongitudeDegrees")[0];
    const el=n.getElementsByTagName("AltitudeMeters")[0];
    pts.push([
      la?parseFloat(la.textContent):0,
      lo?parseFloat(lo.textContent):0,
      el?parseFloat(el.textContent):0
    ]);
  });
  return pts;
}

/* ====== COMPUTE METRICS ====== */
function compute(pts){
  if(pts.length<2) return {km:0,gain:0,e:[],d:[]};
  const elev=pts.map(p=>p[2]);
  const d=[0]; let dist=0,gain=0;
  for(let i=1;i<pts.length;i++){
    const dd=hav(pts[i-1][0],pts[i-1][1],pts[i][0],pts[i][1]);
    if(dd<300) dist+=dd;
    d[i]=dist;
    const de=elev[i]-elev[i-1];
    if(de>1) gain+=de;
  }
  return {km:dist/1000,gain,e:elev,d};
}

/* ====== GLOBAL STATE ====== */
let gpxPts=[], metrics={e:[],d:[]};

/* ====== LOAD GPX ====== */
document.getElementById("gpxfile").addEventListener("change",async e=>{
  const f=e.target.files[0];
  if(!f) return;
  const txt=await f.text();
  const xml=new DOMParser().parseFromString(txt,"application/xml");
  gpxPts=parseTrack(xml);
  metrics=compute(gpxPts);

  document.getElementById("dist").value=metrics.km.toFixed(3);
  document.getElementById("dplus").value=metrics.gain;
  document.getElementById("gpxInfo").textContent=
    `Punti: ${gpxPts.length}, ${metrics.km.toFixed(2)} km, D+: ${metrics.gain} m`;

  drawTrack();
  drawProfile();
});

/* ====== LEAFLET ====== */
let map=null,poly=null,hoverMarker=null;

function initLeaflet(){
  if(map) return;
  map=L.map("leafletMap");
  L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{
    maxZoom:19,
    attribution:"© OpenStreetMap contributors"
  }).addTo(map);
  hoverMarker=L.circleMarker([0,0],{radius:6,color:"#ff0",fillColor:"#ff0"});
  map.setView([46.5,8.3],5);
}

function drawTrack(){
  if(!map||!gpxPts.length)return;
  if(poly) map.removeLayer(poly);
  poly=L.polyline(gpxPts.map(p=>[p[0],p[1]]),{color:"#4fd1c5",weight:4}).addTo(map);
  fitTrack();
}

function fitTrack(){
  if(poly) map.fitBounds(poly.getBounds(),{padding:[20,20]});
}

document.getElementById("btnFit").onclick=fitTrack;

/* ====== KML ====== */
document.getElementById("btnKml").onclick=()=>{
  if(!gpxPts.length){alert("Carica prima un GPX");return;}
  const coords=gpxPts.map(p=>`${p[1]},${p[0]},${p[2]}`).join(" ");
  const kml=`<?xml version="1.0"?>
<kml xmlns="http://www.opengis.net/kml/2.2"><Document>
<Placemark><name>Percorso</name>
<LineString><coordinates>${coords}</coordinates></LineString>
</Placemark></Document></kml>`;
  const blob=new Blob([kml],{type:"application/vnd.google-earth.kml+xml"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="wiztrail.kml";
  a.click();
};

/* ====== DISTANCE LINE (marcatori ogni 5 km) ====== */
function drawDistanceLine(){
  const canvas = document.getElementById("distCanvas");
  const stats  = document.getElementById("distStats");
  const ctx = canvas.getContext("2d");

  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  const dpr = window.devicePixelRatio || 1;

  canvas.width = w * dpr;
  canvas.height = h * dpr;
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, w, h);

  if(!metrics || !metrics.d.length){
    stats.textContent = "Carica una traccia per mostrare la progressione chilometrica.";
    return;
  }

  // distanza totale in km
  const distKm = metrics.km;
  const maxKm = Math.ceil(distKm / 5) * 5;

  stats.textContent = `Distanza totale: ${distKm.toFixed(2)} km`;

  const leftPad = 40;
  const rightPad = 10;
  const lineY = h / 2;

  // linea orizzontale base
  ctx.strokeStyle = "#4fd1c5";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(leftPad, lineY);
  ctx.lineTo(w - rightPad, lineY);
  ctx.stroke();

  // marcatore ogni 5 km
  const usableW = w - leftPad - rightPad;

  ctx.strokeStyle = "#ffcc00";
  ctx.fillStyle = "#ffcc00";
  ctx.lineWidth = 2;
  ctx.font = "12px system-ui";

  for(let km = 0; km <= maxKm; km += 5){
    const x = leftPad + (km / maxKm) * usableW;

    // tacchetta verticale
    ctx.beginPath();
    ctx.moveTo(x, lineY - 12);
    ctx.lineTo(x, lineY + 12);
    ctx.stroke();

    // etichetta
    ctx.fillText(`${km} km`, x - 10, lineY + 28);
  }

  // marcatore finale reale (non multiplo di 5 km)
  if(distKm % 5 !== 0){
    const x = leftPad + (distKm / maxKm) * usableW;
    ctx.strokeStyle = "#ff6b6b";
    ctx.fillStyle   = "#ff6b6b";

    ctx.beginPath();
    ctx.moveTo(x, lineY - 14);
    ctx.lineTo(x, lineY + 14);
    ctx.stroke();

    ctx.fillText(`${distKm.toFixed(1)} km`, x - 18, lineY + 28);
  }
}
/* ====== CALCOLO TEMPO ====== */
document.getElementById("calcBtn").onclick=()=>{
  const msg=document.getElementById("msg");
  msg.textContent="";
  const t10=document.getElementById("t10k").value;
  if(!/^[0-9]+:[0-5][0-9]$/.test(t10)){msg.textContent="Formato 10K non valido";return;}
  const m10=parseInt(t10.split(":")[0])+parseInt(t10.split(":")[1])/60;

  const D=parseFloat(document.getElementById("dist").value);
  const Dp=parseFloat(document.getElementById("dplus").value);
  const a=parseFloat(document.getElementById("alpha").value);

  /* RIEGEL DINAMICO */
  let expo;
  if(D<=20) expo=1.03+0.002*(D-10);
  else if(D<=42) expo=1.05+0.0007*(D-20);
  else expo=1.075;

  const HM=m10*Math.pow(21.097/10,expo);
  const D_eq=D+(Dp/100)*a;
  const T_elev=HM*(D_eq/D);

  const pS=+document.getElementById("p_strada").value/100;
  const pE=+document.getElementById("p_e").value/100;
  const pEE=+document.getElementById("p_ee").value/100;
  const pEA=+document.getElementById("p_ea").value/100;
  if(Math.abs(pS+pE+pEE+pEA-1)>0.01){msg.textContent="Somma % ≠100";return;}

  const cE=+document.getElementById("c_e").value/100;
  const cEE=+document.getElementById("c_ee").value/100;
  const cEA=+document.getElementById("c_ea").value/100;
  const terr = pS*1 + pE*(1+cE) + pEE*(1+cEE) + pEA*(1+cEA);

  const bm=+document.getElementById("meteo").value;
  const ba=+document.getElementById("alt").value;

  /* FATICA MODULATA DALLA DISTANZA */
  let fw;
  if(D<=20) fw=0.25;
  else if(D<=40) fw=0.25+0.03*(D-20);
  else fw=1.0;

  const bf_raw=+document.getElementById("fatica").value;
  const bf=1+(bf_raw-1)*fw;

  const S=+document.getElementById("spec").value;
  const mrg=+document.getElementById("margin").value/100;

  const raw = terr*bm*ba*bf;
  const adj = 1+(raw-1)*(1-0.6*S);

  const T=T_elev*adj;

  const fmt=t=>{
    const s=Math.round(t*60);
    const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),se=s%60;
    return h?`${h}:${String(m).padStart(2,"0")}:${String(se).padStart(2,"0")}`
            :`${m}:${String(se).padStart(2,"0")}`;
  };

  document.getElementById("outFinal").textContent=fmt(T);
  document.getElementById("outLow").textContent=fmt(T*(1-mrg));
  document.getElementById("outHigh").textContent=fmt(T*(1+mrg));
  msg.textContent="OK";
};

/* RESET */
document.getElementById("resetBtn").onclick=()=>location.reload();

</script>

</body>
</html>